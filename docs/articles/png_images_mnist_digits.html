<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>png_images_mnist_digits â€¢ rTorch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="png_images_mnist_digits">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rTorch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9009</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/idx_images_minist_digits.html">idx_images_minist_digits</a>
    </li>
    <li>
      <a href="../articles/linear_regression_rainfall.html">linear_regression_rainfall</a>
    </li>
    <li>
      <a href="../articles/logistic_regression_mnist_digits_idx.html">logistic_regression_mnist_digits_idx</a>
    </li>
    <li>
      <a href="../articles/png_images_mnist_digits.html">png_images_mnist_digits</a>
    </li>
    <li>
      <a href="../articles/two_layer_neural_network.html">two_layer_neural_network</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/f0nzie/rTorch">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>png_images_mnist_digits</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/f0nzie/rTorch/blob/master/vignettes/png_images_mnist_digits.Rmd"><code>vignettes/png_images_mnist_digits.Rmd</code></a></small>
      <div class="hidden name"><code>png_images_mnist_digits.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rTorch)</a></code></pre></div>
<div id="digits-recognition-on-png-images--r-code" class="section level1">
<h1 class="hasAnchor">
<a href="#digits-recognition-on-png-images--r-code" class="anchor"></a>Digits recognition on PNG images. R code</h1>
<ol style="list-style-type: decimal">
<li>Added utility functions</li>
<li>Introspection on dim=2. Extra layers on tensor</li>
<li>Converting code from Python to R</li>
<li>Read PNG images instead of the MNIST standard dataset (IDX format)</li>
</ol>
<div id="objectives" class="section level2">
<h2 class="hasAnchor">
<a href="#objectives" class="anchor"></a>Objectives</h2>
<ol style="list-style-type: decimal">
<li>Read PNG images instead of MNIST standard dataset.</li>
<li>Save the model</li>
<li>Read an unseen digit using the model</li>
<li>Predict digit and calculate accuracy</li>
</ol>
</div>
<div id="load-pytorch-libraries" class="section level2">
<h2 class="hasAnchor">
<a href="#load-pytorch-libraries" class="anchor"></a>Load PyTorch libraries</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">nn          &lt;-<span class="st"> </span>torch<span class="op">$</span>nn</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">transforms  &lt;-<span class="st"> </span>torchvision<span class="op">$</span>transforms</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">dsets       &lt;-<span class="st"> </span>torchvision<span class="op">$</span>datasets</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">builtins    &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/import">import_builtins</a></span>()</a></code></pre></div>
</div>
<div id="dataset-iteration-batch-settings" class="section level2">
<h2 class="hasAnchor">
<a href="#dataset-iteration-batch-settings" class="anchor"></a>Dataset iteration batch settings</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># batch size for datasets</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">batch_size_train =<span class="st"> </span>100L</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">batch_size_test  =<span class="st"> </span>1000L</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># folders where te images are located</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">train_data_path =<span class="st"> '~/mnist_png_full/training/'</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">test_data_path  =<span class="st"> '~/mnist_png_full/testing/'</span></a></code></pre></div>
</div>
<div id="read-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#read-datasets" class="anchor"></a>Read datasets</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># read the datasets without normalization</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">train_dataset =<span class="st"> </span>torchvision<span class="op">$</span>datasets<span class="op">$</span><span class="kw">ImageFolder</span>(<span class="dt">root =</span> train_data_path, </a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="dt">transform =</span> torchvision<span class="op">$</span>transforms<span class="op">$</span><span class="kw">ToTensor</span>()</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">test_dataset =<span class="st"> </span>torchvision<span class="op">$</span>datasets<span class="op">$</span><span class="kw">ImageFolder</span>(<span class="dt">root =</span> test_data_path, </a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="dt">transform =</span> torchvision<span class="op">$</span>transforms<span class="op">$</span><span class="kw">ToTensor</span>()</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(train_dataset), <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(test_dataset), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; 60000 10000</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">train_dataset<span class="op">$</span><span class="st">`</span><span class="dt">__len__</span><span class="st">`</span>()</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; [1] 60000</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">class</a></span>(train_dataset)        <span class="co"># &lt;class 'torchvision.datasets.folder.ImageFolder'&gt;</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; [1] "torchvision.datasets.folder.ImageFolder"  </span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; [2] "torchvision.datasets.folder.DatasetFolder"</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; [3] "torchvision.datasets.vision.VisionDataset"</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; [4] "torch.utils.data.dataset.Dataset"         </span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; [5] "python.builtin.object"</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co"># in Python train_dataset[0] is a tuple</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co"># In R, this will produce an error</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co"># expect_error(class(train_dataset[0]))      # &lt;class 'tuple'&gt;</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"></a>
<a class="sourceLine" id="cb4-26" data-line-number="26">train_dataset</a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="co">#&gt; Dataset ImageFolder</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="co">#&gt;     Number of datapoints: 60000</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="co">#&gt;     Root location: /home/msfz751/mnist_png_full/training/</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="co"># Dataset ImageFolder</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31"><span class="co">#     Number of datapoints: 60000</span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="co">#     Root location: /home/msfz751/mnist_png_full/training/</span></a></code></pre></div>
</div>
<div id="read-image-and-label-for-a-data-point" class="section level2">
<h2 class="hasAnchor">
<a href="#read-image-and-label-for-a-data-point" class="anchor"></a>Read image and label for a data point</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># retrieve a random data point from the dataset</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">random &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/import">import</a></span>(<span class="st">"random"</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">i_rand =<span class="st"> </span>random<span class="op">$</span><span class="kw">randrange</span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(train_dataset)<span class="op">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">i_rand</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; [1] 48597</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co"># the Python object is a tuple with two elements</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co"># But in R returns as a list of two elements</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">dataset_object =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, i_rand)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">dataset_object</a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt; tensor([[[0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt;          ...,</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.]],</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="co">#&gt;         [[0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co">#&gt;          ...,</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.]],</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28"><span class="co">#&gt;         [[0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-31" data-line-number="31"><span class="co">#&gt;          ...,</span></a>
<a class="sourceLine" id="cb5-32" data-line-number="32"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-33" data-line-number="33"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.],</span></a>
<a class="sourceLine" id="cb5-34" data-line-number="34"><span class="co">#&gt;          [0., 0., 0.,  ..., 0., 0., 0.]]])</span></a>
<a class="sourceLine" id="cb5-35" data-line-number="35"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37"><span class="co">#&gt; [1] 8</span></a>
<a class="sourceLine" id="cb5-38" data-line-number="38"></a>
<a class="sourceLine" id="cb5-39" data-line-number="39"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">class</a></span>(dataset_object)</a>
<a class="sourceLine" id="cb5-40" data-line-number="40"><span class="co">#&gt; [1] "list"</span></a>
<a class="sourceLine" id="cb5-41" data-line-number="41"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(dataset_object)</a>
<a class="sourceLine" id="cb5-42" data-line-number="42"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb5-43" data-line-number="43"></a>
<a class="sourceLine" id="cb5-44" data-line-number="44">image &lt;-<span class="st"> </span>dataset_object[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb5-45" data-line-number="45">label &lt;-<span class="st"> </span>dataset_object[[<span class="dv">2</span>]]</a></code></pre></div>
<p>The size of the image tensor is <code>torch.Size([3, 28, 28])</code> but it should really be <code>torch.Size([1, 28, 28])</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">image<span class="op">$</span><span class="kw">size</span>()  <span class="co"># torch.Size([3, 28, 28])</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; torch.Size([3, 28, 28])</span></a></code></pre></div>
<div id="introspection-of-train_dataset" class="section level3">
<h3 class="hasAnchor">
<a href="#introspection-of-train_dataset" class="anchor"></a>Introspection of train_dataset</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">builtins<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/typeof">type</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 0L))</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; &lt;class 'list'&gt;</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"</span><span class="ch">\t</span><span class="st">first member of the tuple is a tensor for the image"</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; [1] "\tfirst member of the tuple is a tensor for the image"</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">builtins<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/typeof">type</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 0L)[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; &lt;class 'torch.Tensor'&gt;</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"</span><span class="ch">\t</span><span class="st">second member of the tuple is an integer for the label"</span>)</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt; [1] "\tsecond member of the tuple is an integer for the label"</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">builtins<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/typeof">type</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 0L)[[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt; &lt;class 'int'&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># check size of first and last data point tensor, image part</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 0L)[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw">size</span>()      <span class="co"># first object</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; torch.Size([3, 28, 28])</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 59999L)[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw">size</span>()  <span class="co"># last object</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt; torch.Size([3, 28, 28])</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">image<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt; torch.Size([3, 28, 28])</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co"># it is torch.Size([3, 28, 28]) but it should be 1, 28, 28</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co"># we will take only one slice of dim=1</span></a></code></pre></div>
</div>
<div id="size-of-tensor-on-dim2" class="section level3">
<h3 class="hasAnchor">
<a href="#size-of-tensor-on-dim2" class="anchor"></a>Size of tensor on dim=2</h3>
<p>The tensors on dim=2 seem to be identical. We will confirm in the following chunk:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># dim=2 has three layers. choose only one</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co"># but find out if all of them are the same</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">image[<span class="dv">0</span>, :, :].size()   <span class="co"># take only one slice in dim=2</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">image[<span class="dv">1</span>, :, :].size()   <span class="co"># take only one slice in dim=2</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">image[<span class="dv">2</span>, :, :].size()   <span class="co"># take only one slice in dim=2</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co"># same value for sums of the tensors means that all tensors are virtually the same</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">image[<span class="dv">0</span>, :, :].<span class="bu">sum</span>()   <span class="co"># take only one slice in dim=2</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">image[<span class="dv">1</span>, :, :].<span class="bu">sum</span>()   <span class="co"># take only one slice in dim=2</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">image[<span class="dv">2</span>, :, :].<span class="bu">sum</span>()   <span class="co"># take only one slice in dim=2</span></a></code></pre></div>
</div>
<div id="take-one-slice-of-dim2" class="section level3">
<h3 class="hasAnchor">
<a href="#take-one-slice-of-dim2" class="anchor"></a>Take one slice of dim=2</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># select one layer of the tensor. 28x28 is the grid space</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># take a slice 0:1 but could have been 1:2 or 2:3</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">image[<span class="dv">0</span>:<span class="dv">1</span>, :, :].size()</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">image[<span class="dv">0</span>:<span class="dv">1</span>, :, :].numpy().shape</a></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">image[<span class="dv">1</span>, , ]<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; torch.Size([28, 28])</span></a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">rotate &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(x, <span class="dv">2</span>, rev))   <span class="co"># function to rotate the matrix</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># the label for the corresponding tensor</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(label)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; [1] 8</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co"># convert to numpy array and reshape</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">img_np_rs =<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(image[<span class="dv">1</span>,,]<span class="op">$</span><span class="kw">numpy</span>(), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(28L, 28L))</a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(<span class="kw">rotate</span>(img_np_rs))</a></code></pre></div>
<p><img src="png_images_mnist_digits_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div id="retrieve-a-second-data-point" class="section level3">
<h3 class="hasAnchor">
<a href="#retrieve-a-second-data-point" class="anchor"></a>Retrieve a second data point</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># second random data point</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">i_rand =<span class="st"> </span>random<span class="op">$</span><span class="kw">randrange</span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(train_dataset)<span class="op">-</span><span class="dv">1</span>)   <span class="co"># get a random data point</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">dataset_object =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, i_rand)    <span class="co"># read the tuple</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">image &lt;-<span class="st"> </span>dataset_object[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">label &lt;-<span class="st"> </span>dataset_object[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co"># the label for the corresponding tensor</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(label)</a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt; [1] 3</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co"># convert to numpy array and reshape</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">img_np_rs =<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(image[<span class="dv">1</span>,,]<span class="op">$</span><span class="kw">numpy</span>(), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(28L, 28L))</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(<span class="kw">rotate</span>(img_np_rs))</a></code></pre></div>
<p><img src="png_images_mnist_digits_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
</div>
<div id="reduce-the-number-of-layers-for-dim1-in-the-image" class="section level2">
<h2 class="hasAnchor">
<a href="#reduce-the-number-of-layers-for-dim1-in-the-image" class="anchor"></a>Reduce the number of layers for dim=1 in the image</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># this class to be used to get rid of two duplicate layers in the image</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">main &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_run">py_run_string</a></span>(<span class="st">'</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">class PickLayerTransform:</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">    def __init__(self, layer):</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">        # self.img_ds = img</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">        self.layer = layer</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">        if self.layer &lt; 0: raise RuntimeError("Layer index {} cannot be negative ".format(self.layer))</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">        </span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="st">    def __call__(self, img):</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="st">        if (self.layer &gt; len(img)-1): raise RuntimeError("Layer index {} incompatible with dimension size {}".format(self.layer, len(img)))</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="st">        return img[(self.layer-1):self.layer, :, :]</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="st">'</span>)</a>
<a class="sourceLine" id="cb14-13" data-line-number="13"></a>
<a class="sourceLine" id="cb14-14" data-line-number="14">PickLayerTransform &lt;-<span class="st"> </span>main<span class="op">$</span>PickLayerTransform</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="co"># trying to resize tensor to [1, 28, 28]</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17">train_dataset =<span class="st"> </span>torchvision<span class="op">$</span>datasets<span class="op">$</span><span class="kw">ImageFolder</span>(<span class="dt">root =</span> train_data_path,</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">    <span class="dt">transform =</span> torchvision<span class="op">$</span>transforms<span class="op">$</span><span class="kw">Compose</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb14-19" data-line-number="19">              transforms<span class="op">$</span><span class="kw">ToTensor</span>(),</a>
<a class="sourceLine" id="cb14-20" data-line-number="20">              <span class="kw">PickLayerTransform</span>(1L)</a>
<a class="sourceLine" id="cb14-21" data-line-number="21">    )))</a>
<a class="sourceLine" id="cb14-22" data-line-number="22"></a>
<a class="sourceLine" id="cb14-23" data-line-number="23">test_dataset =<span class="st"> </span>torchvision<span class="op">$</span>datasets<span class="op">$</span><span class="kw">ImageFolder</span>(<span class="dt">root =</span> test_data_path,</a>
<a class="sourceLine" id="cb14-24" data-line-number="24">    <span class="dt">transform =</span> torchvision<span class="op">$</span>transforms<span class="op">$</span><span class="kw">Compose</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">              transforms<span class="op">$</span><span class="kw">ToTensor</span>(),</a>
<a class="sourceLine" id="cb14-26" data-line-number="26">              <span class="kw">PickLayerTransform</span>(1L)</a>
<a class="sourceLine" id="cb14-27" data-line-number="27">    )))</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># check size of a data point tensor, image part</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co"># train_dataset[0][0].size()       # first object</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co"># train_dataset[59999][0].size()   # last object</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 0L)[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; torch.Size([1, 28, 28])</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, 59999L)[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; torch.Size([1, 28, 28])</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co"># this image generated before eliminating 2 extra layers</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"previous image size"</span>)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt; [1] "previous image size"</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12">image<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt; torch.Size([3, 28, 28])</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co"># it is torch.Size([3, 28, 28]) but it should be 1, 28, 28</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co"># we will take only one slice of dim=1</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co"># the other two layers are the same</span></a></code></pre></div>
<div id="show-a-random-image" class="section level3">
<h3 class="hasAnchor">
<a href="#show-a-random-image" class="anchor"></a>Show a random image</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">i_rand =<span class="st"> </span>random<span class="op">$</span><span class="kw">randrange</span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(train_dataset)<span class="op">-</span><span class="dv">1</span>)   <span class="co"># get a random data point</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">dataset_object &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_get_item">py_get_item</a></span>(train_dataset, i_rand)    <span class="co"># read the tuple</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">image &lt;-<span class="st"> </span>dataset_object[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">label &lt;-<span class="st"> </span>dataset_object[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb16-7" data-line-number="7"></a>
<a class="sourceLine" id="cb16-8" data-line-number="8">image<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co">#&gt; torch.Size([1, 28, 28])</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">class</a></span>(label)</a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="co">#&gt; [1] "integer"</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="co"># the label for the corresponding tensor</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(label)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="co">#&gt; [1] 7</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="co"># convert to numpy array and reshape</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="co"># we don't need to specify the layer index anymore</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"><span class="co"># we can use this form:</span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20">  <span class="co"># img_np_rs = img[:, :, :].numpy().reshape(28, 28) in Python</span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21">  <span class="co"># or this:</span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22">img_np_rs =<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(image<span class="op">$</span><span class="kw">numpy</span>(), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(28L, 28L))</a>
<a class="sourceLine" id="cb16-23" data-line-number="23"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(<span class="kw">rotate</span>(img_np_rs))</a></code></pre></div>
<p><img src="png_images_mnist_digits_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div id="apply-data-loader-and-batch-size" class="section level3">
<h3 class="hasAnchor">
<a href="#apply-data-loader-and-batch-size" class="anchor"></a>Apply data loader and batch size</h3>
<p>To prevent losing features by using a simple for loop to iterate over the data. In particular, we are missing out on:</p>
<pre><code>Batching the data
Shuffling the data
Load the data in parallel using multiprocessing workers.</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># load the dataset of images</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">train_loader =<span class="st"> </span>torch<span class="op">$</span>utils<span class="op">$</span>data<span class="op">$</span><span class="kw">DataLoader</span>(</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">        train_dataset,</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">        <span class="dt">batch_size=</span>batch_size_train,</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">        <span class="dt">shuffle=</span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">    )</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co"># load the dataset of images</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">test_loader =<span class="st"> </span>torch<span class="op">$</span>utils<span class="op">$</span>data<span class="op">$</span><span class="kw">DataLoader</span>(</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">        test_dataset,</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">        <span class="dt">batch_size=</span>batch_size_test,</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">        <span class="dt">shuffle=</span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">    )</a>
<a class="sourceLine" id="cb18-14" data-line-number="14"></a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(train_loader), <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(test_loader))</a>
<a class="sourceLine" id="cb18-16" data-line-number="16"><span class="co">#&gt; 600 10</span></a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># Confirm that the dataset loaders are iterable objects</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">collections &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/import">import</a></span>(<span class="st">"collections"</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">builtins<span class="op">$</span><span class="kw">isinstance</span>(train_loader, collections<span class="op">$</span>Iterable)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">builtins<span class="op">$</span><span class="kw">isinstance</span>(test_loader, collections<span class="op">$</span>Iterable)</a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
</div>
</div>
<div id="build-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#build-the-model" class="anchor"></a>Build the model</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co"># Build the model</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="co"># Same as linear regression! </span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">main &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_run">py_run_string</a></span>(<span class="st">"</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="st">import torch.nn as nn</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="st">class LogisticRegressionModel(nn.Module):</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="st">    def __init__(self, input_dim, output_dim):</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="st">        super(LogisticRegressionModel, self).__init__()</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="st">        self.linear = nn.Linear(input_dim, output_dim)</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="st">    def forward(self, x):</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="st">        out = self.linear(x)</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="st">        return out</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="st">"</span>)</a>
<a class="sourceLine" id="cb20-15" data-line-number="15"></a>
<a class="sourceLine" id="cb20-16" data-line-number="16">LogisticRegressionModel &lt;-<span class="st"> </span>main<span class="op">$</span>LogisticRegressionModel</a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="co"># feeding the model with 28x28 images</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2">input_dim =<span class="st"> </span>28L<span class="op">*</span>28L</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="co"># classify digits 0-9 a total of 10 classes,</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5">output_dim =<span class="st"> </span>10L</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co"># instantiate model</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8">model =<span class="st"> </span><span class="kw">LogisticRegressionModel</span>(input_dim, output_dim)</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">model</a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="co">#&gt; LogisticRegressionModel(</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="co">#&gt;   (linear): Linear(in_features=784, out_features=10, bias=True)</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="co">#&gt; )</span></a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co">### Instantiate Cross Entropy Loss class</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co"># need Cross Entropy Loss to calculate loss before we backpropagation</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3">criterion =<span class="st"> </span>nn<span class="op">$</span><span class="kw">CrossEntropyLoss</span>()  </a>
<a class="sourceLine" id="cb22-4" data-line-number="4"></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co"># calculate parameters' gradients and update</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6">learning_rate =<span class="st"> </span><span class="fl">0.001</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co">### Instantiate Optimizer class</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9">optimizer =<span class="st"> </span>torch<span class="op">$</span>optim<span class="op">$</span><span class="kw">SGD</span>(model<span class="op">$</span><span class="kw">parameters</span>(), <span class="dt">lr=</span>learning_rate)  </a>
<a class="sourceLine" id="cb22-10" data-line-number="10">optimizer</a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt; SGD (</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="co">#&gt; Parameter Group 0</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co">#&gt;     dampening: 0</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="co">#&gt;     lr: 0.001</span></a>
<a class="sourceLine" id="cb22-15" data-line-number="15"><span class="co">#&gt;     momentum: 0</span></a>
<a class="sourceLine" id="cb22-16" data-line-number="16"><span class="co">#&gt;     nesterov: False</span></a>
<a class="sourceLine" id="cb22-17" data-line-number="17"><span class="co">#&gt;     weight_decay: 0</span></a>
<a class="sourceLine" id="cb22-18" data-line-number="18"><span class="co">#&gt; )</span></a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># Type of parameter object</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(model<span class="op">$</span><span class="kw">parameters</span>())</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="co">#&gt; &lt;generator object Module.parameters at 0x7fa0f60327c8&gt;</span></a>
<a class="sourceLine" id="cb23-4" data-line-number="4">model_parameters &lt;-<span class="st"> </span>builtins<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(model<span class="op">$</span><span class="kw">parameters</span>())</a>
<a class="sourceLine" id="cb23-5" data-line-number="5"></a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="co"># Length of parameters</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(builtins<span class="op">$</span><span class="kw">len</span>(model_parameters))</a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9"></a>
<a class="sourceLine" id="cb23-10" data-line-number="10"><span class="co"># FC 1 Parameters </span></a>
<a class="sourceLine" id="cb23-11" data-line-number="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(builtins<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(model_parameters)[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw">size</span>())</a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="co">#&gt; torch.Size([10, 784])</span></a>
<a class="sourceLine" id="cb23-13" data-line-number="13"></a>
<a class="sourceLine" id="cb23-14" data-line-number="14"><span class="co"># FC 1 Bias Parameters</span></a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(builtins<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(model_parameters)[[<span class="dv">2</span>]]<span class="op">$</span><span class="kw">size</span>())</a>
<a class="sourceLine" id="cb23-16" data-line-number="16"><span class="co">#&gt; torch.Size([10])</span></a></code></pre></div>
<p>We arbitrarily set 3000 iterations here which means the model would update 3000 times.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">n_iters =<span class="st"> </span>3000L</a></code></pre></div>
<p>One epoch consists of 60,000 / 100 = 600 iterations. Because we would like to go through 3000 iterations, this implies we would have 3000 / 600 = 5 epochs as each epoch has 600 iterations.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">num_epochs =<span class="st"> </span>n_iters <span class="op">/</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_len">py_len</a></span>(train_dataset) <span class="op">/</span><span class="st"> </span>batch_size_train)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">num_epochs =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(num_epochs)</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">num_epochs</a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="co">#&gt; [1] 5</span></a></code></pre></div>
</div>
<div id="training-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#training-the-model" class="anchor"></a>Training the model</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co"># train the model</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">iter &lt;-<span class="st"> </span>0L</a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="cf">for</span> (epoch <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>num_epochs) {</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">    iter_train_dataset &lt;-<span class="st"> </span>builtins<span class="op">$</span><span class="kw">enumerate</span>(train_loader) <span class="co"># reset iterator</span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5">    <span class="cf">for</span> (train_obj <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/iterate">iterate</a></span>(iter_train_dataset)) {</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">        <span class="co"># extract images, labels</span></a>
<a class="sourceLine" id="cb26-7" data-line-number="7">        images &lt;-<span class="st"> </span>train_obj[[<span class="dv">2</span>]][[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">        labels &lt;-<span class="st"> </span>train_obj[[<span class="dv">2</span>]][[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">        <span class="co"># Load images as Variable</span></a>
<a class="sourceLine" id="cb26-10" data-line-number="10">        images =<span class="st"> </span>images<span class="op">$</span><span class="kw">view</span>(<span class="op">-</span>1L, 28L<span class="op">*</span>28L)<span class="op">$</span><span class="kw">requires_grad_</span>()</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">        labels =<span class="st"> </span>labels</a>
<a class="sourceLine" id="cb26-12" data-line-number="12">        <span class="co"># Clear gradients w.r.t. parameters</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13">        optimizer<span class="op">$</span><span class="kw">zero_grad</span>()</a>
<a class="sourceLine" id="cb26-14" data-line-number="14">        <span class="co"># Forward pass to get output/logits</span></a>
<a class="sourceLine" id="cb26-15" data-line-number="15">        <span class="co"># outputs = model(torch$as_tensor(images, dtype = torch$double))</span></a>
<a class="sourceLine" id="cb26-16" data-line-number="16">        outputs =<span class="st"> </span><span class="kw">model</span>(images)</a>
<a class="sourceLine" id="cb26-17" data-line-number="17">        <span class="co"># Calculate Loss: softmax --&gt; cross entropy loss</span></a>
<a class="sourceLine" id="cb26-18" data-line-number="18">        loss =<span class="st"> </span><span class="kw">criterion</span>(outputs, labels)</a>
<a class="sourceLine" id="cb26-19" data-line-number="19">        <span class="co"># Getting gradients w.r.t. parameters</span></a>
<a class="sourceLine" id="cb26-20" data-line-number="20">        loss<span class="op">$</span><span class="kw">backward</span>()</a>
<a class="sourceLine" id="cb26-21" data-line-number="21">        <span class="co"># Updating parameters</span></a>
<a class="sourceLine" id="cb26-22" data-line-number="22">        optimizer<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/step">step</a></span>()</a>
<a class="sourceLine" id="cb26-23" data-line-number="23">        iter =<span class="st"> </span>iter <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb26-24" data-line-number="24">        <span class="cf">if</span> (iter <span class="op">%%</span><span class="st"> </span><span class="dv">500</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb26-25" data-line-number="25">            <span class="co"># Calculate Accuracy for each epoch</span></a>
<a class="sourceLine" id="cb26-26" data-line-number="26">            correct &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb26-27" data-line-number="27">            total &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb26-28" data-line-number="28">            <span class="co"># Iterate through test dataset</span></a>
<a class="sourceLine" id="cb26-29" data-line-number="29">            iter_test_dataset &lt;-<span class="st"> </span>builtins<span class="op">$</span><span class="kw">enumerate</span>(test_loader) <span class="co"># reset iterator</span></a>
<a class="sourceLine" id="cb26-30" data-line-number="30">            <span class="cf">for</span> (test_obj <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/iterate">iterate</a></span>(iter_test_dataset)) {</a>
<a class="sourceLine" id="cb26-31" data-line-number="31">                <span class="co"># Load images to a Torch Variable</span></a>
<a class="sourceLine" id="cb26-32" data-line-number="32">                images &lt;-<span class="st"> </span>test_obj[[<span class="dv">2</span>]][[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb26-33" data-line-number="33">                labels &lt;-<span class="st"> </span>test_obj[[<span class="dv">2</span>]][[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb26-34" data-line-number="34">                images &lt;-<span class="st"> </span>images<span class="op">$</span><span class="kw">view</span>(<span class="op">-</span>1L, 28L<span class="op">*</span>28L)<span class="op">$</span><span class="kw">requires_grad_</span>()</a>
<a class="sourceLine" id="cb26-35" data-line-number="35">                <span class="co"># Forward pass only to get logits/output</span></a>
<a class="sourceLine" id="cb26-36" data-line-number="36">                <span class="co"># outputs = model(torch$as_tensor(images, dtype = torch$double))</span></a>
<a class="sourceLine" id="cb26-37" data-line-number="37">                outputs =<span class="st"> </span><span class="kw">model</span>(images)</a>
<a class="sourceLine" id="cb26-38" data-line-number="38">                <span class="co"># Get predictions from the maximum value</span></a>
<a class="sourceLine" id="cb26-39" data-line-number="39">                .predicted =<span class="st"> </span>torch<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(outputs<span class="op">$</span>data, 1L)</a>
<a class="sourceLine" id="cb26-40" data-line-number="40">                predicted &lt;-<span class="st"> </span>.predicted[1L]</a>
<a class="sourceLine" id="cb26-41" data-line-number="41">                <span class="co"># Total number of labels</span></a>
<a class="sourceLine" id="cb26-42" data-line-number="42">                total =<span class="st"> </span>total <span class="op">+</span><span class="st"> </span>labels<span class="op">$</span><span class="kw">size</span>(0L)</a>
<a class="sourceLine" id="cb26-43" data-line-number="43">                <span class="co"># Total correct predictions</span></a>
<a class="sourceLine" id="cb26-44" data-line-number="44">                correct =<span class="st"> </span>correct <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>((predicted<span class="op">$</span><span class="kw">numpy</span>() <span class="op">==</span><span class="st"> </span>labels<span class="op">$</span><span class="kw">numpy</span>()))</a>
<a class="sourceLine" id="cb26-45" data-line-number="45">            }</a>
<a class="sourceLine" id="cb26-46" data-line-number="46">            accuracy =<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>correct <span class="op">/</span><span class="st"> </span>total</a>
<a class="sourceLine" id="cb26-47" data-line-number="47">            <span class="co"># Print Loss</span></a>
<a class="sourceLine" id="cb26-48" data-line-number="48">            <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">'Iteration: %5d. Loss: %f. Accuracy: %8.2f </span><span class="ch">\n</span><span class="st">'</span>,</a>
<a class="sourceLine" id="cb26-49" data-line-number="49">                  iter, loss<span class="op">$</span><span class="kw">item</span>(), accuracy))</a>
<a class="sourceLine" id="cb26-50" data-line-number="50">        }</a>
<a class="sourceLine" id="cb26-51" data-line-number="51">    }</a>
<a class="sourceLine" id="cb26-52" data-line-number="52">}</a>
<a class="sourceLine" id="cb26-53" data-line-number="53"><span class="co">#&gt; Iteration:   500. Loss: 1.854970. Accuracy:    65.22 </span></a>
<a class="sourceLine" id="cb26-54" data-line-number="54"><span class="co">#&gt; Iteration:  1000. Loss: 1.578890. Accuracy:    75.24 </span></a>
<a class="sourceLine" id="cb26-55" data-line-number="55"><span class="co">#&gt; Iteration:  1500. Loss: 1.296880. Accuracy:    78.85 </span></a>
<a class="sourceLine" id="cb26-56" data-line-number="56"><span class="co">#&gt; Iteration:  2000. Loss: 1.209047. Accuracy:    80.61 </span></a>
<a class="sourceLine" id="cb26-57" data-line-number="57"><span class="co">#&gt; Iteration:  2500. Loss: 1.104562. Accuracy:    81.77 </span></a>
<a class="sourceLine" id="cb26-58" data-line-number="58"><span class="co">#&gt; Iteration:  3000. Loss: 0.967193. Accuracy:    82.66</span></a></code></pre></div>
<blockquote>
<p>This is a modified version of the original article.</p>
</blockquote>
<p>Source: <a href="https://www.deeplearningwizard.com/deep_learning/practical_pytorch/pytorch_logistic_regression/" class="uri">https://www.deeplearningwizard.com/deep_learning/practical_pytorch/pytorch_logistic_regression/</a></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#digits-recognition-on-png-images--r-code">Digits recognition on PNG images. R code</a><ul class="nav nav-pills nav-stacked">
<li><a href="#objectives">Objectives</a></li>
      <li><a href="#load-pytorch-libraries">Load PyTorch libraries</a></li>
      <li><a href="#dataset-iteration-batch-settings">Dataset iteration batch settings</a></li>
      <li><a href="#read-datasets">Read datasets</a></li>
      <li><a href="#read-image-and-label-for-a-data-point">Read image and label for a data point</a></li>
      <li><a href="#reduce-the-number-of-layers-for-dim1-in-the-image">Reduce the number of layers for dim=1 in the image</a></li>
      <li><a href="#build-the-model">Build the model</a></li>
      <li><a href="#training-the-model">Training the model</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Alfonso R. Reyes.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
